name: "Build XCFramework for MacCatalyst"

on:
  workflow_dispatch:
  push:
  #workflow_dispatch:
  #  branches: [main, develop]


jobs:
  build_macabi_xcf:
    runs-on: macos-latest
    steps:
      - name: check Xcode version and Python 3
        run: |
          /usr/bin/xcodebuild -version
          brew uninstall --ignore-dependencies python
          brew install python@3.10
          #brew install python3
          ls /usr/local/bin/python*
          echo "alias python=/usr/local/bin/python3.10" >> ~/.zshrc
          echo "alias python3=/usr/local/bin/python3.10" >> ~/.zshrc
          alias python3=/usr/local/bin/python3.10
          alias python=/usr/local/bin/python3.10
          python3 --version
          python --version

      - name: checkout repository
        uses: actions/checkout@v3

      - name: install protoc
        run : |
          mkdir -p $HOME/Downloads
          cd $HOME/Downloads
          curl -LJO https://github.com/protocolbuffers/protobuf/releases/download/v21.12/protoc-21.12-osx-universal_binary.zip
          unzip protoc-21.12-osx-universal_binary.zip -d protoc-21.12-osx-universal_binary
          mv protoc-21.12-osx-universal_binary/bin/protoc /usr/local/bin/protoc-3.21.12.0
          mv protoc-21.12-osx-universal_binary/include/* /usr/local/include/
 
      - name: create directory to store the library
        run: mkdir -p $HOME/onnxlibrary/macabi_release_v20230327_2320

      - name: create release build
        run: |
          # Since Python 3.12, distutils is removed
          # pip3 install setuptools
          pip install -r tools/ci_build/requirements.txt
          python tools/ci_build/github/apple/build_macabi_framework.py --config=Release --build_dir=$HOME/onnxlibrary/macabi_release_v20230327_2320 \
            --include_ops_by_config=tools/ci_build/github/apple/hws_mobile_package.required_operators.config \
            --path_to_protoc_exe=/usr/local/bin/protoc-3.21.12.0 tools/ci_build/github/apple/default_full_macabi_framework_build_settings.json
